---
title: "MAT5317 Categorical Assignment 2"
author:
- Teng Li(7373086)
- Zhize Lu(300075114)
- Chutong Zhang(300311325)
output: 
  bookdown::html_document2:
    toc: true
header-includes:
- \renewcommand{\and}{\\}
- \usepackage{float}
- \floatplacement{figure}{H}
bibliography: References.bib
link-citations: yes
---

<style type="text/css">
.title, .author{text-align: center;}
body{font-size: 12pt;}
table{font-size: 12pt;}
h1{font-size: 14pt;}
h2{font-size: 12pt;}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
library(tidyverse)
library(plotly)
library(kableExtra)
library(DescTools)
library(gt)
library(stargazer)
```

```{r}
CCAHS<-read.csv("CCAHS.csv", header = TRUE)
Covid<-read.csv("Covid.csv", header = TRUE)
WMortality<-read.csv("WeeklyMortality.csv", header = TRUE)
ExMortality<-read.csv("ExcessMortality.csv", header = TRUE)
LongTerm<-read.csv("LongTerm.csv", header = TRUE)
```

# Introduction

The COVID-19 pandemic, caused by the novel coronavirus SARS-CoV-2, has had an unprecedented impact on global health, economies, and daily life since its emergence in late 2019. As the world fights with the challenges posed by this highly contagious virus, epidemiological data have been continuously gathered and released to the public, driving numerous researches and different approaches in trying to understand its patterns of transmission, to identify vulnerable populations, and to inform public health strategies. Due to the severity of the early stage of the pandemic and its wide impact on global production, data of high quality and accuracy were gathered in the nation through surveys and reports, so we believed that the COVID-19 data sets could be more informative and extensive than other epidemiology data.

In this assignment, we looked into the COVID-19 epidemiology data sets provided by Statistics Canada along with other related data sets. We attempted to answer three major questions in three subsections:

1. We wanted to find if there was a possible relationship between the COVID pandemic and the excess mortality for 2020, 2021 and 2022. Through this question, one might be able to draw insights on whether the virus has had a dangerous impact on the overall public health.

2. We gathered data of COVID-19 long term symptom among Canadian adults. We wanted to draw some conclusions on whether the virus had any impact on the long-term health condition of Canadians.

3. We wanted to measure the relationship between the risk prevalence and some factors like vaccination status, chronic conditions and having or not a direct contact with people etc. By building a statistical model between the response and predictors, it helped us understand what procedures or conditions can affect the prevalence of COVID-19.  

# Method

## Section 1: Mortality
We used two data sets to explore the relationship between COVID-19 and the mortality in Canada. First data set is focus on the COVID-19 cases and death published by government of Canada to explore the number of new infections and deaths numbers in Canada and updates every Monday morning from Feb.01ï¼Œ2020 to Oct.28, 2023. 
This data set contains 2940 observations of 23 variables with the 
```{r}
#data dictionary:Covid cases and death
COVID<-Covid%>%
  select(prname,date,reporting_year,totalcases,numtotal_last7,numdeaths,numdeaths_last7)

CovidDD<-data.frame(
  Variables=colnames(COVID),   
  Type=sapply(COVID, function(x) class(x)),
  Example=sapply(COVID, function(x) paste(as.character(head(unique(x),2)), collapse = ", ")),
  Number.Unique=sapply(COVID, function(x) length(unique(x))),
  PctMissing=sapply(COVID, function(x) paste0(round(sum(is.na(x))/length(x), 4)*100,"%")),
  Comment=c( "English name of jurisdiction (province, territory, Canada)",
              "Last day of the epidemiologic week for which the data represent. Epidemiological weeks are from Sunday to Saturday and this date will always fall on a Saturday.",
             "The calendar year associated with the epidemiologic week (based on the Fluwatch weeks calendar) in which the data was reported.(2020-2023)",
              "The total number of cases reported from January 2020 until the end of the reporting week in a jurisdiction.",
             "Total number of cases during the reporting week for a jurisdiction, minus the total number of cases from that jurisdiction's previous week's update.",
             "The total number of deaths reported from January 2020 until the end of the reporting week in a jurisdiction.",
             "Total number of deaths for a jurisdiction, minus the total number of deaths from that jurisdiction's previous week's update."
             
           )
)
CovidDD%>%
  gt()%>%tab_header(
    title = "Table 2.1.1: COVID-19 Cases and Death Data Dictionary")

```
Second data set is the provisional weekly death counts, by ages and sex from 2010 to 2023, published by StatCan. this data set record the 149730 observations of 17 variables that are relevant for monitoring the impacts of COVID-19 on mortality in Canada.
```{r}
#data dictionary:Weekly mortality
mortality<-WMortality%>%
  select(REF_DATE,GEO,Age.at.time.of.death,Sex,Characteristics,UOM,VALUE)
data.frame(
  Variables=colnames(mortality),   
  Type=sapply(mortality, function(x) class(x)),
  Example=sapply(mortality, function(x) paste(as.character(head(unique(x),2)), collapse = ", ")),
  Number.Unique=sapply(mortality, function(x) length(unique(x))),
  PctMissing=sapply(mortality, function(x) paste0(round(sum(is.na(x))/length(x), 4)*100,"%")),
  Comment=c("Reference period for the series being released.(2010-2023)",
             "Name of dimension. There can be up to 10 dimensions in a data table.
(i.e. Geography)",
             "Age grouo when death occurred",
             "Sex ",
             "Number of deaths",
             "The unit of measure applied to a member given in text.",
             "Total number of death under certain characteristics"
           )
)%>%gt()%>%tab_header(
    title = "Table 2.1.2: Weekly Mortality Data Dictionary")


```
In order to have better understanding about the mortality in Canada, we visualize the weekly death counts every year form 2010 to 2023 in Figure(), it is clear to see that the  the number of annual
deaths is increasing every year. The overall trend from 2010 to 2019 is similar, with an general  decrease from the begging to the middle of the year then followed by an upward trend until the year end. In the middle of 2020 and the beginning of 2022, there exist two significant spikes on the figure. These pronounced increases in case counts raise the possibility that they may be attributed to distinct outbreaks of the epidemic. 
To verify this conjecture, we showed the weekly number of death without the COVID-19 cases in Figure(). The spikes in 2020 and 2022 are removed but the small spike in mid-2021 still exist. So death counts rapid increase in 2020 and 2022 may caused by COVID-19 and we will discuss the relationship between COVID-19 and mortality in the following section.
```{r}
#vizualize the death with and without covid
WMortality%>%
  mutate(Year=year(REF_DATE),Week=substr(REF_DATE,6,10))%>%
  mutate(Year=factor(Year))%>%
  filter(Age.at.time.of.death=="Age at time of death, all ages" & Sex=="Both sexes" & GEO=="Canada, place of occurrence")%>%
  plot_ly(x=~Week, y=~VALUE, color=~Year,type = "scatter", mode="lines")%>%
  layout(title = 'Weekly Death Counts', yaxis = list(title = "Number of Death"))

Withoutc<-WMortality%>%
  mutate(Year=year(REF_DATE),Week=substr(REF_DATE,6,10))%>%
  filter(Age.at.time.of.death=="Age at time of death, all ages" & Sex=="Both sexes" & GEO=="Canada, place of occurrence",Year>="2020")%>%
  select(REF_DATE,Year, Week, GEO,Characteristics,VALUE)%>%
  na.omit()
 Withoutc<-Withoutc[-c(1:4),]
CO<-Covid%>%
  filter(prname=="Canada")%>%
  select(date,numdeaths_last7)
  colnames(CO)[1] <- "REF_DATE"

WOMortality<-WMortality%>%
  mutate(Year=year(REF_DATE),Week=substr(REF_DATE,6,10))%>%
  filter(Age.at.time.of.death=="Age at time of death, all ages" & Sex=="Both sexes" & GEO=="Canada, place of occurrence")%>%
  select(REF_DATE,Year, Week, GEO,Characteristics,VALUE)
 WOMortality<- merge(WOMortality,CO,by="REF_DATE",all=TRUE)
 WOMortality<- WOMortality[-c(707:721),]
 WOMortality$numdeaths_last7[is.na( WOMortality$numdeaths_last7)] = 0
WOMortality%>%
  mutate(Death_without_covid=VALUE-numdeaths_last7)%>%
  plot_ly( x=~Week, y=~Death_without_covid, color=~factor(Year),type = "scatter", mode="lines")%>%
layout(title = 'Weekly Death Counts without COIVD',yaxis = list(title = "Number of Death without COVID"))
```

## Section 2: Long-term Impact

## Section 3: Prevalence Modeling

# Result

## Section 1: Mortality
For annual mortality,
```{r}
#Contingency table for mortality rate VS year(Odds Ratio)
tdeath<-WOMortality%>%
  filter( Year>="2020")%>%
  group_by(Year)%>%
  summarise(TotalDeath=sum(VALUE),Totalcoviddeath=sum(numdeaths_last7), CDrate=Totalcoviddeath/TotalDeath)
Y=tdeath$CDrate
tbl<-data.frame(cbind(Y,1-Y))
colnames(tbl)<-c("Covid", "Not Covid")
rownames(tbl)<-c("2020", "2021","2022","2023")
  kable(tbl, caption = "Contingency Table for Year and Death in Canada")%>%
  add_header_above(c(" ", "Death" = 2))%>%
  column_spec(1:1, width = "8em",bold=TRUE)%>%
  kable_styling(bootstrap_options = c("striped", "condensed"))

OR21=tbl[1,1]*tbl[2,2]/(tbl[1,2]*tbl[2,1])
OR22=tbl[1,1]*tbl[3,2]/(tbl[1,2]*tbl[3,1])
OR23=tbl[1,1]*tbl[4,2]/(tbl[1,2]*tbl[4,1])
ORtbl<-data.frame(OR21,OR22,OR23)
colnames(ORtbl)<-c("2021 ", "2022","2023")
rownames(ORtbl)<-"Odds Ratio"
ORtbl%>%
  kable(caption = "Odds ratio for three years") %>%
  kable_styling(bootstrap_options = c("striped", "condensed"))
```


```{r}
# table(chi-square)
YC=tdeath$Totalcoviddeath
NC=tdeath$TotalDeath-tdeath$Totalcoviddeath
ntbl<-data.frame(cbind(YC,NC))
colnames(ntbl)<-c("Covid", "Not Covid")
rownames(ntbl)<-c("2020", "2021","2022","2023")
  kable(ntbl, caption = "Contingency Table for Year and Death in Canada")%>%
  add_header_above(c(" ", "Death" = 2))%>%
  column_spec(1:1, width = "8em",bold=TRUE)%>%
  kable_styling(bootstrap_options = c("striped", "condensed"))
chisq.test(ntbl)

```

We were interested in the effect of COVID-19 on mortality in different seasons.
 For Spring,
```{r}
# three way table(Year x Death x Season)
seasonal<-WOMortality%>%
  mutate(Month=factor(substr(REF_DATE,6,7)),
         Season=case_when(
           Month %in% c("03","04","05")~"Spring",
           Month %in% c("06","07","08")~"Summer",
           Month %in% c("09","10","11")~"Autumn",
           Month %in% c("12","01","02")~"Winter",
         ))%>%
  filter(Year>=2020)%>%
  select(REF_DATE,Year,Month,Season,VALUE,numdeaths_last7)
  colnames(seasonal)[5] <- "Totaldeath"
  
# Table (Spring)
Spring<-seasonal%>%
  filter(Season=="Spring")%>%
 group_by(Year)%>%
  summarise(TotalDeath=sum(Totaldeath),Totalcoviddeath=sum(numdeaths_last7), CDrate=Totalcoviddeath/TotalDeath)
Pspr=Spring$CDrate
sprtbl<-data.frame(cbind(Pspr,1-Pspr))
colnames(sprtbl)<-c("Covid", "Not Covid")
rownames(sprtbl)<-c("2020","2021","2022","2023")
  kable(sprtbl, caption = "Contingency Table for Year and Death in Spring")%>%
  add_header_above(c(" ", "Death on Spring" = 2))%>%
  column_spec(1:1, width = "8em",bold=TRUE)%>%
  kable_styling(bootstrap_options = c("striped", "condensed"))
```

For Summer
```{r}
# Table (Summer)
sum<-seasonal%>%
  filter(Season=="Summer")%>%
 group_by(Year)%>%
  summarise(TotalDeath=sum(Totaldeath),Totalcoviddeath=sum(numdeaths_last7), CDrate=Totalcoviddeath/TotalDeath)
Psum=sum$CDrate
sumtbl<-data.frame(cbind(Psum,1-Psum))
colnames(sumtbl)<-c("Covid", "Not Covid")
rownames(sumtbl)<-c("2020","2021","2022","2023")
  kable(sumtbl, caption = "Contingency Table for Year and Death in Summer")%>%
  add_header_above(c(" ", "Death on Summer" = 2))%>%
  column_spec(1:1, width = "8em",bold=TRUE)%>%
  kable_styling(bootstrap_options = c("striped", "condensed"))
```

For Autumn
```{r}
# Table (Autumn)
aut<-seasonal%>%
  filter(Season=="Autumn")%>%
 group_by(Year)%>%
  summarise(TotalDeath=sum(Totaldeath),Totalcoviddeath=sum(numdeaths_last7), CDrate=Totalcoviddeath/TotalDeath)
Paut=aut$CDrate
auttbl<-data.frame(cbind(Paut,1-Paut))
colnames(auttbl)<-c("Covid", "Not Covid")
rownames(auttbl)<-c("2020","2021","2022")
  kable(auttbl, caption = "Contingency Table for Year and Death in Autumn")%>%
  add_header_above(c(" ", "Death on Autumn" = 2))%>%
  column_spec(1:1, width = "8em",bold=TRUE)%>%
  kable_styling(bootstrap_options = c("striped", "condensed"))
```
For winter
```{r}
# Table (Winter)
win<-seasonal%>%
  filter(Season=="Winter")%>%
 group_by(Year)%>%
  summarise(TotalDeath=sum(Totaldeath),Totalcoviddeath=sum(numdeaths_last7), CDrate=Totalcoviddeath/TotalDeath)
Pwin=win$CDrate
wintbl<-data.frame(cbind(Pwin,1-Pwin))
colnames(wintbl)<-c("Covid", "Not Covid")
rownames(wintbl)<-c("2020","2021","2022","2023")
  kable(wintbl, caption = "Contingency Table for Year and Death in Winter")%>%
  add_header_above(c(" ", "Death on Winter" = 2))%>%
  column_spec(1:1, width = "8em",bold=TRUE)%>%
  kable_styling(bootstrap_options = c("striped", "condensed"))
```

The Odds ratio for all seasons,
```{r}
#OR in Spring
sprOR21=sprtbl[1,1]*sprtbl[2,2]/(sprtbl[1,2]*sprtbl[2,1])
sprOR22=sprtbl[1,1]*sprtbl[3,2]/(sprtbl[1,2]*sprtbl[3,1])
sprOR23=sprtbl[1,1]*sprtbl[4,2]/(sprtbl[1,2]*sprtbl[4,1])
sprORtbl<-data.frame(sprOR21,sprOR22,sprOR23)
colnames(sprORtbl)<-c("2021 ", "2022","2023")
rownames(sprORtbl)<-"Odds Ratio"

#OR in Summer
sumOR21=sumtbl[1,1]*sumtbl[2,2]/(sumtbl[1,2]*sumtbl[2,1])
sumOR22=sumtbl[1,1]*sumtbl[3,2]/(sumtbl[1,2]*sumtbl[3,1])
sumOR23=sumtbl[1,1]*sumtbl[4,2]/(sumtbl[1,2]*sumtbl[4,1])
sumORtbl<-data.frame(sumOR21,sumOR22,sumOR23)
colnames(sumORtbl)<-c("2021 ", "2022","2023")
rownames(sumORtbl)<-"Odds Ratio"

#OR in Autumn
autOR21=auttbl[1,1]*auttbl[2,2]/(auttbl[1,2]*auttbl[2,1])
autOR22=auttbl[1,1]*auttbl[3,2]/(auttbl[1,2]*auttbl[3,1])
autOR23=auttbl[1,1]*auttbl[4,2]/(auttbl[1,2]*auttbl[4,1])
autORtbl<-data.frame(autOR21,autOR22,autOR23)
colnames(autORtbl)<-c("2021 ", "2022","2023")
rownames(autORtbl)<-"Odds Ratio"

#OR in Winter
winOR21=wintbl[1,1]*wintbl[2,2]/(wintbl[1,2]*wintbl[2,1])
winOR22=wintbl[1,1]*wintbl[3,2]/(wintbl[1,2]*wintbl[3,1])
winOR23=wintbl[1,1]*wintbl[4,2]/(wintbl[1,2]*wintbl[4,1])
winORtbl<-data.frame(winOR21,winOR22,winOR23)
colnames(winORtbl)<-c("2021 ", "2022","2023")
rownames(winORtbl)<-"Odds Ratio"

AORtbl=rbind(sprORtbl,sumORtbl,autORtbl,winORtbl)
rownames(AORtbl)<-c("Spring(Mar.- May.)","Summer(Jun.- Aug.)","Autumn(Sept.- Nov.)","Winter(Dec.- Feb.)")

AORtbl%>%
  kable(caption = "Odds ratio for three years in Different seasons") %>%
  kable_styling(bootstrap_options = c("striped", "condensed"))
```
## Section 2: Long-term Impact

## Section 3: Prevalence Modeling

```{r}
WMortality%>%mutate(Year=year(REF_DATE), Week=substr(REF_DATE,6,10))%>%mutate(Year=factor(Year))%>%filter(Age.at.time.of.death=="Age at time of death, all ages" & Sex=="Both sexes" & GEO=="Canada, place of occurrence")%>%
  plot_ly(x=~Week, y=~VALUE, color=~Year,type = "scatter", mode="lines")
```

# Discussion

## Section 1: Mortality

## Section 2: Long-term Impact

## Section 3: Prevalence Modeling

# Conclusion

# References
