---
title: "MAT5317 Categorical Assignment 2"
author:
- Teng Li(7373086)
- Zhize Lu(300075114)
- Chutong Zhang(300311325)
output: 
  html_notebook: 
    toc: yes
    number_sections: yes
    fig_caption: yes
header-includes:
- \renewcommand{\and}{\\}
- \usepackage{float}
- \floatplacement{figure}{H}
bibliography: References.bib
link-citations: yes
---

<style type="text/css">
.title, .author{text-align: center;}
body{font-size: 12pt;}
table{font-size: 12pt;}
h1{font-size: 14pt;}
h2{font-size: 12pt;}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(plotly)
library(kableExtra)
library(bestglm)
library(gt)
library(stargazer)
library(DescTools)
```

```{r}
CCAHS<-read.csv("CCAHS.csv", header = TRUE)
Covid<-read.csv("Covid.csv", header = TRUE)
Covid_aG<-read.csv("COVID_AgeGender.csv", header = TRUE)
WMortality<-read.csv("WeeklyMortality.csv", header = TRUE)
ExMortality<-read.csv("ExcessMortality.csv", header = TRUE)
LongTerm<-read.csv("LongTerm.csv", header = TRUE)
```

# Introduction

The COVID-19 pandemic, caused by the novel coronavirus SARS-CoV-2, has had an unprecedented impact on global health, economies, and daily life since its emergence in late 2019. As the world fights with the challenges posed by this highly contagious virus, epidemiological data have been continuously gathered and released to the public, driving numerous researches and different approaches in trying to understand its patterns of transmission, to identify vulnerable populations, and to inform public health strategies. Due to the severity of the early stage of the pandemic and its wide impact on global production, data of high quality and accuracy were gathered in the nation through surveys and reports, so we believed that the COVID-19 data sets could be more informative and extensive than other epidemiology data.

In this assignment, we looked into the COVID-19 epidemiology data sets provided by Statistics Canada along with other related data sets. We attempted to answer three major questions in three subsections:

1. We wanted to find if there was a possible relationship between the COVID pandemic and the death counts for 2020, 2021, 2022 and 2023. Through this question, one might be able to draw insights on whether the virus has had a dangerous impact on the overall public health.

2. We gathered data of COVID-19 long term symptom among Canadian adults. We wanted to draw some conclusions on whether the virus had any impact on the long-term health condition of Canadians.

3. We wanted to measure the relationship between the risk prevalence and some factors like vaccination status, chronic conditions and having or not a direct contact with people etc. By building a statistical model between the response and predictors, it helped us understand what procedures or conditions can affect the prevalence of COVID-19.  

# Method

## Mortality
We used two data sets to explore the relationship between COVID-19 and the mortality in Canada. First data set is focus on the COVID-19 cases and death published by government of Canada to explore the number of new infections and deaths numbers in Canada and updates every Monday morning from Feb.01，2020 to Oct.28, 2023. 

This first data set published by government of Canada[@GOC], it contains 2940 observations of 23 variables,including the total number of COVID-19 infections and deaths and their rates from January 2020 until the end of the reporting week, weekly and bi-weekly number of infection and deaths and their rates. Additionally, it includes the average daily death counts and rates derived from both weekly and bi-weekly data. In this section, our analysis emphasizes variables that pertain to both weekly and overall data. The data dictionary detailing the selected variables is provided below.
```{r}
#data dictionary:Covid cases and death
COVID<-Covid%>%
  select(prname,date,reporting_year,totalcases,numtotal_last7,numdeaths,numdeaths_last7)

CovidDD<-data.frame(
  Variables=colnames(COVID),   
  Type=sapply(COVID, function(x) class(x)),
  Example=sapply(COVID, function(x) paste(as.character(head(unique(x),2)), collapse = ", ")),
  Number.Unique=sapply(COVID, function(x) length(unique(x))),
  PctMissing=sapply(COVID, function(x) paste0(round(sum(is.na(x))/length(x), 4)*100,"%")),
  Comment=c( "English name of jurisdiction (province, territory, Canada)",
              "Last day of the epidemiologic week for which the data represent. Epidemiological weeks are from Sunday to Saturday and this date will always fall on a Saturday.",
             "The calendar year associated with the epidemiologic week (based on the Fluwatch weeks calendar) in which the data was reported.(2020-2023)",
              "The total number of cases reported from January 2020 until the end of the reporting week in a jurisdiction.",
             "Total number of cases during the reporting week for a jurisdiction, minus the total number of cases from that jurisdiction's previous week's update.",
             "The total number of deaths reported from January 2020 until the end of the reporting week in a jurisdiction.",
             "Total number of deaths for a jurisdiction, minus the total number of deaths from that jurisdiction's previous week's update."
             
           )
)
CovidDD%>%
  gt()%>%tab_header(
    title = "Table 2.1.1: COVID-19 Cases and Death Data Dictionary")

```
From the Table 2.1.1, we found that the percentage of missing value in weekly cases and death counts are abound 10%, which is not good for our research. Missing values are mainly found in the northern and southeastern provinces and territories, such as Nunavut and Nova Scotia. In order to avoid the impact of missing values on the study, we use the total death and infections of COVID-19 in Canada instead of every province and terrotory in the following discussion.

Second data set is the provisional weekly death counts, by ages and sex from 2010 to 2023, published by Statistics Canada. This data set record the 149730 observations of 17 variables that are relevant for monitoring the impacts of mortality of every province and territory in Canada. We also deleted some variables which are irrelevant with our study or can not delivered the useful information in this data set. Such as variables like STATUS and TERMINATED are missing in all observation in this data set and variables DECIMALS and UOM_ID are the same for all variables. The data dictionary for remaining variables is provided below.
```{r}
#data dictionary:Weekly mortality
mortality<-WMortality%>%
  select(REF_DATE,GEO,Age.at.time.of.death,Sex,Characteristics,UOM,VALUE)
data.frame(
  Variables=colnames(mortality),   
  Type=sapply(mortality, function(x) class(x)),
  Example=sapply(mortality, function(x) paste(as.character(head(unique(x),2)), collapse = ", ")),
  Number.Unique=sapply(mortality, function(x) length(unique(x))),
  PctMissing=sapply(mortality, function(x) paste0(round(sum(is.na(x))/length(x), 4)*100,"%")),
  Comment=c("Reference period for the series being released.(2010-2023)",
             "Name of dimension. There can be up to 10 dimensions in a data table.
(i.e. Geography)",
             "Age grouo when death occurred",
             "Sex ",
             "Number of deaths",
             "The unit of measure applied to a member given in text.",
             "Total number of death under certain characteristics"
           )
)%>%gt()%>%tab_header(
    title = "Table 2.1.2: Weekly Mortality Data Dictionary")


```
The total number of death in this data set exist 9.25% missing data in raw data set, the missing data appears in all data after July 15, 2023. Because we only use the data in Canada with all age group and both sexes, the missing data only accounted for less than 1% of the data set we filtered. Therefore, we our study focused on the overall total death account and the number of COVID-19 deaths in Canada during the period January 2022 to July 2023.

In order to have better understanding about the mortality in Canada, we visualize the weekly death counts every year form 2010 to 2023 in Figure2.1.2, it is clear to see that the  the number of annual deaths is increasing every year. The overall trend from 2010 to 2019 is similar, with an general decrease from the begging to the middle of the year then followed by an upward trend until the year end. In the middle of 2020 and the beginning of 2022, there exist two significant spikes on the figure. These pronounced increases in case counts raise the possibility that they may be attributed to distinct outbreaks of the epidemic. 

```{r}
#vizualize the death with and without covid
WMortality%>%
  mutate(Year=year(REF_DATE),Week=substr(REF_DATE,6,10))%>%
  mutate(Year=factor(Year))%>%
  filter(Age.at.time.of.death=="Age at time of death, all ages" & Sex=="Both sexes" & GEO=="Canada, place of occurrence")%>%
  plot_ly(x=~Week, y=~VALUE, color=~Year,type = "scatter", mode="lines")%>%
  layout(width = 900, height = 500,title = 'Figure2.1.2:Weekly Death Counts', yaxis = list(title = "Number of Death"))
```

```{r}
Withoutc<-WMortality%>%
  mutate(Year=year(REF_DATE),Week=substr(REF_DATE,6,10))%>%
  filter(Age.at.time.of.death=="Age at time of death, all ages" & Sex=="Both sexes" & GEO=="Canada, place of occurrence",Year>="2020")%>%
  select(REF_DATE,Year, Week, GEO,Characteristics,VALUE)%>%
  na.omit()
 Withoutc<-Withoutc[-c(1:4),]
CO<-Covid%>%
  filter(prname=="Canada")%>%
  select(date,numdeaths_last7)
  colnames(CO)[1] <- "REF_DATE"

WOMortality<-WMortality%>%
  mutate(Year=year(REF_DATE),Week=substr(REF_DATE,6,10))%>%
  filter(Age.at.time.of.death=="Age at time of death, all ages" & Sex=="Both sexes" & GEO=="Canada, place of occurrence")%>%
  select(REF_DATE,Year, Week, GEO,Characteristics,VALUE)
 WOMortality<- merge(WOMortality,CO,by="REF_DATE",all=TRUE)
 WOMortality<- WOMortality[-c(707:721),]
 WOMortality$numdeaths_last7[is.na( WOMortality$numdeaths_last7)] = 0
WOMortality%>%
  mutate(Death_without_covid=VALUE-numdeaths_last7)%>%
  plot_ly( x=~Week, y=~Death_without_covid, color=~factor(Year),type = "scatter", mode="lines")%>%
layout(width = 900, height = 500, title = 'Figure2.1.3:Weekly Death Counts without COIVD cases',yaxis = list(title = "Number of Death without COVID"))
```
To verify this conjecture, we showed the weekly number of death without the COVID-19 cases in Figure2.1.3. The spikes in 2020 and 2022 are removed but the small spike in mid-2021 still exist. So death counts rapid increase in 2020 and 2022 may caused by COVID-19 and we will discuss the probability of  COVID-19 deaths in the total number of death condition on year in the following section.

## Long-term Impact

The data of COVID-19 long term symptom among Canadian adults is from the Canadian COVID-19 Antibody and Health Survey (CCAHS) Cycle2. The survey collected the data over 3 collection periods between April 2022 and August 2022. The target population for this survey was adults 18 years of age and older living in the 10 provinces across Canada. Respondents who reported experiencing symptoms at least three months after a positive COVID-19 test were considered to have long-term symptoms.[@LongTerm] The long term symptoms data used in this study has been pre-processed by Statistics Canada. It is grouped by sex and age groups. The measure is binary response from the respondents. The value shows the percentage of responses within each specific group. The confidence intervals are provided in the assessment of point estimates in case of high variability in the data. 

The definition of main variables in the data is shown in following Table 2.2.1.

```{r}
DataDict_data <- LongTerm[,c(1,2,4,5,6,7,8,14,18)]

DataDict<-data.frame(
  Variables=colnames(DataDict_data),   
  Type=sapply(DataDict_data, function(x) class(x)),
  Example=sapply(DataDict_data, function(x) paste(as.character(head(unique(x),2)), collapse = ", ")),
  Number.Unique=sapply(DataDict_data, function(x) length(unique(x))),
  PctMissing=sapply(DataDict_data, function(x) paste0(round(sum(is.na(x))/length(x), 4)*100,"%")),
  Comment=c("Reference Year (2022)",
                  "Geographic Location (Canada)",
                  "Does the respondent have the long term symptoms? Yes or No.",
                  "Sex Category",
                  "Age Groups",
                  "Characteristics of the value, estimate or confidence interval",
                  "Unit of Measure (Percentage of the group)",
                  "Data Value",
                  "Number of Decimal Places in Value")
)
DataDict%>%gt()%>%tab_header(
    title = "Table 2.2.1: Long Term Symptoms Data Definition")
```

In the study, we dropped variables like "REF_DATE", "GEO" which contain the survey information and are the same across the entire data. A data of current COVID-19 cases in Canada [@COVIDCASE_AG] was used to estimate the missing variables necessary for the test we applied in later Section 3.2.

## Prevalence Modeling

We used the Canadian COVID-19 Antibody and Health Survey (CCAHS) Cycle 1 microdata in modeling the prevelance. The CCAHS is collecting key information relevant to the pandemic to learn as much as possible about the virus, how it affects overall health, how it spreads, and whether Canadians are developing antibodies against it. [@CCAHS] The survey contained two parts, an electronic questionnaire and an at-home blood test. The questionnaire aimed to get general health and exposure conditions of participants, whereas the blood test was used to determine the presence of COVID-19 antibodies.

The survey was designed as cross-sectional and was given to individuals over 1 years old, excluding the population in remote areas of Canada. The data were sampled randomly from 30 strata created from each province. Due to the various size of the population of each stratum, Statistics Canada had to adjust the sample size in those strata with a larger population and higher proportion of COVID confirmed cases, ensuring a precise estimate of the prevalence. In addition, a two-stage sampling method was done at the household level, from which one of the household members was selected for the survey. In total, a sample size of 47900 people were selected and about 23.0% responded completely the survey.

The resulted data contained 10978 number of responses and 99 variables. Due to the large size of the number of variables, we only selected the ones that we were mostly interested in. We believed that the selected variables were most likely significant in modeling the prevalence before attempting to look into the data. After all, a variable showing if the respondent had a family doctor or not might be less likely to affect the prevalence than a variable showing the vaccination status. However, one must note that there might be predictors that could indirectly affect the response variable. For example, one could find the variable showing the response to the following question: "What are the reasons you would not get the COVID-19 vaccine? - Do not consider it necessary to get the vaccine". This variable might have influence on the prevalence because no vaccine was given to the respondent. However, we thought that it was rather less informative because the information was already reflected in vaccination status. Therefore, we only chose those variables that can have a direct impact on the prevalence. Moreover, variables could have invalid categories like "Valid skip" or "Not stated". These categories were present due to regulation and law reinforcement, and the survey is designed entirely voluntary. Therefore these categories were treated by us as missing data. Any variable with a high percentage of missing values (>25%) were dropped. 

We gave a data definition in Table 2.3.1 below. 

```{r}
RegressionData<-CCAHS%>%transmute(Covid_Status=case_when(CS_35==1 ~ "Yes", CS_35==2 ~ "No", .default = NA),
                                  chronic=case_when(CHRGNUM==0 ~ "No", CHRGNUM==9 ~ NA, .default = "Yes"),
                                  DirectContact=case_when(RA_10==2 ~ "Yes", RA_10==9 ~ NA, .default = "No"),
                                  Smoke=case_when(RA_35==1 ~ "Yes", RA_35==2 ~ "No", .default = NA),
                                  WashHand=case_when(HB_20A==1~"Always",HB_20A==2~"Often",HB_20A==3~"Occasionally",HB_20A==4~"Never",.default = NA),
                                  WearMask=case_when(HB_20B==1~"Always",HB_20B==2~"Often", HB_20B==3~"Occasionally", HB_20B==4~"Never",.default = NA),
                                  Keep2m=case_when(HB_20D==1~"Always",HB_20D==2~"Often", HB_20D==3~"Occasionally", HB_20D==4~"Never",.default = NA),
                                  AvoidCrowds=case_when(HB_20E==1~"Always",HB_20E==2~"Often", HB_20E==3~"Occasionally", HB_20E==4~"Never",.default = NA),
                                  FluVac=case_when(FLU_05==1~"Yes",FLU_05==2~"No",.default = NA),
                                  VaccineStatus=case_when(VXD05==1 ~ "Yes", VXD05==2 ~ "No", .default = NA),
                                  Sex=case_when(GDR_05==9~NA, .default = GDR_05),
                                  Age=case_when(AGEGRP==9~NA,.default = AGEGRP),
                                  NumHouse=case_when(HHCDV==9~NA,.default = HHCDV),
                                  AntiBodyResult=factor(case_when(LABDCOVD==1~"Positive",LABDCOVD==2~"Negative",LABDCOVD==3~"Indeterminate"), levels = c("Negative", "Indeterminate", "Positive"))
)%>%
  mutate(across(c(Covid_Status, chronic, DirectContact, Smoke, FluVac, VaccineStatus), ~factor(., levels = c("No", "Yes"))))%>%
  mutate(across(c(WashHand, WearMask, Keep2m, AvoidCrowds), ~factor(., levels = c("Never", "Occasionally","Often", "Always"))))%>%
  mutate(across(c(Sex, Age, NumHouse), factor))
 

DataDict<-data.frame(
  Variables=colnames(RegressionData),   
  Type=sapply(RegressionData, function(x) class(x)),
  Example=sapply(RegressionData, function(x) paste(as.character(head(unique(x),2)), collapse = ", ")),
  Number.Unique=sapply(RegressionData, function(x) length(unique(x))),
  PctMissing=sapply(RegressionData, function(x) paste0(round(sum(is.na(x))/length(x), 4)*100,"%")),
  Comment=c("Had the respondent ever had a positive test result?",
                  "Had the respondent reported having chronic condition?",
                  "In the last six months, had the respondent worked in direct contact with people?",
                  "Does the respondent currently smoke tobacco?",
                  "Wash hands often?",
                  "Wear a mask in indoor public spaces where physical distancing is difficult or a mandatory mask by-law exists?",
                  "Keep a 2 meter or 6 foot distance from others?",
                  "Avoid crowds and large gatherings?",
                  "In the past 12 months, have you had a seasonal flu vaccine?",
                  "Received at least one vaccine dose against COVID-19?",
                  "Sex: 1 - Male, 2 - Female",
                  "Age group: 1-19, 20-39, 40-59, 60 and older",
                  "Number of people living in household: 1, 2, 3, and 4 or more",
                  "The overall interpretation of the laboratory result is that if 0 of 3 antigen tests was positive, the respondent had an overall negative test for antibodies against SARS-CoV-2, if 1 of 3 antigen tests was positive, the respondent had an overall indeterminate test for antibodies against SARS-CoV-2, and if 2 or more of 3 antigen tests were positive, the respondent had an overall positive test for antibodies against SARS-CoV-2.")
)
DataDict%>%gt()%>%tab_header(
    title = "Table 2.3.1: COVID Status Data Definition")
```

To fully understand the relationship between the response variable Covid_Status with other predictors, we fitted logistic models in Section 3.3 and provided additional inferences. 

# Result


## Mortality
In order to discuss the probability of COVID-19 death in the total death, we first calculated the proportion for the COVID-19 death from 2020 to 2023 in Table 3.1.1. To our surprise, the proportion in 2022 is the higher than the proportion in 2020, 0.0574 and 0.0490 respectively. This might because the outbreak of the new variant Omicron. The proportion in 2021 and 2023 are relatively low might because the population of vaccination increase.
```{r}
#Contingency table for mortality rate VS year(Odds Ratio)
tdeath<-WOMortality%>%
  filter( Year>="2020")%>%
  group_by(Year)%>%
  summarise(TotalDeath=sum(VALUE),Totalcoviddeath=sum(numdeaths_last7), CDrate=Totalcoviddeath/TotalDeath)
Y=round(tdeath$CDrate,4)
tbl<-data.frame(cbind(c(2020,2021,2022,2023),Y,1-Y))
colnames(tbl)<-c("Year","Covid Death", "Not Covid Death")
tbl%>%gt()%>%tab_header(
    title = "Table 3.1.1: Contingency table for proportion of COVID-19 death")
```

To test the homogeneity for COVID-19 death probability condition on years, we can use the Chi-square test and the null and alternative hypothesis of homogeneity corresponding to:
\begin{gather*}
H_0:P_{j|i}\ =\ P_{·j}\\
H_1:P_{j|i}\neq P_{·j}
\end{gather*}

```{r}
# table(chi-square) test homogeneity 
YC=tdeath$Totalcoviddeath
NC=tdeath$TotalDeath-tdeath$Totalcoviddeath
ntbl<-data.frame(cbind(YC,NC))
colnames(ntbl)<-c("Covid", "Not Covid")
ntbls= cbind(c("2020","2021","2022","2023"),ntbl)
  colnames(ntbls)<-c("Year","Covid", "Not Covid")
#ntbls%>%
  #gt()%>%tab_header(
    #title = "Table 3.1.1: Contingency table for death counts")
chi_square<-c(chisq.test(ntbl)$statistic ,GTest(ntbl)$statistic)
p_value<-c(chisq.test(ntbl)$p.value,GTest(ntbl)$p.value)
test<-c("Chi-squated test","Likelihood ratio test")
  Chi<-data.frame(test,chi_square,p_value)
significance_level <- 0.05
Chi%>%
   gt() %>%
  tab_header(
    title = "Table3.1.3:Result for test homogeneity between COVID-19 death and Year"
  ) %>%
   cols_label(
   chi_square = "Chi-Squared Statistic",
    p_value = "P-Value",
    test="Test"
  ) %>%
  fmt(
    columns = vars(p_value),
    fns = function(x) {
      ifelse(x < significance_level, paste("<", significance_level), sprintf("%.3f", x))
    }
  )
```
The Chi-squares statistics computed by Chi-squared test and Likelihood ratio test is different but the p-value is less than 0.05 in both test. Thus we reject the null hypothesis under the 0.05 level since there have  strong evidence that exist significant difference in probability in COVID-19 death probability condition on years.

Then we can compute the relative risk and odds ratio for years to measure the association between years and COVID-19 death proportion. We chose the COVID-19 death proportion in 2020 year as baseline category and compute the relative risks and odds ratios.

```{r}
#Relative Risk
Tbl<-as.matrix(tbl[,c(2,3)])
RR21=round(Tbl[2,1]/Tbl[1,1],4)
RR22=round(Tbl[3,1]/Tbl[1,1],4)
RR23=round(Tbl[4,1]/Tbl[1,1],4)
RRtbl<-data.frame("Relative risk",RR21,RR22,RR23)
colnames(RRtbl)<-c("Year", "2021", "2022","2023")
RRtbl%>%gt()%>%tab_header(
    title = "Table 3.1.4: Relative risks for three years")
```
Table 3.1.4 showed the Relative risks in 2021,2022 and 2023. We can see that relative risks in 2021,and 2023 are less than 1, we can concluded that if a people died in COVID-19, this people is more likely died in 2020 than 2021 and 2023. The relative risk in 2022 are greater than 1, we can concluded that if a people died in COVID-19, this people is more likely died in 2022 than 2020.

```{r}
#Odds ratios
Tbl<-as.matrix(tbl[,c(2,3)])
OR21=round(Tbl[1,1]*Tbl[2,2]/(Tbl[1,2]*Tbl[2,1]),4)
OR22=round(Tbl[1,1]*Tbl[3,2]/(Tbl[1,2]*Tbl[3,1]),4)
OR23=round(Tbl[1,1]*Tbl[4,2]/(Tbl[1,2]*Tbl[4,1]),4)
ORtbl<-data.frame("Odds Ratio",OR21,OR22,OR23)
colnames(ORtbl)<-c("Year", "2021", "2022","2023")
ORtbl%>%gt()%>%tab_header(
    title = "Table 3.1.5: Odds ratio for three years")
```
From Table 3.1.5, we can see that the odds ratios for all three years are not equal to 1, which indicated that there exists association between year and COVID-19 death proportion. For odds ratios in 2021 and 2023, there exist positive association between probability of death caused by COVID-19. The association in 2022 is negative between proportion of COVID-19 death in total death.   

## Long-term Impact

As the data of COVID-19 long term symptom among Canadian adults did not contain the population size and population for each groups. We estimate the counts from the data of Weekly number of COVID-19 cases in Canada as of October 28, 2023. From the data of overall COVID-19 cases, we first grouped the data to the similar structure as our Long Term Symptom data. The data of other genders was dropped because that the count is too small comparing to the total population.
```{r}
#group the longterm data and drop variables not used in the analysis
grouped_data <- LongTerm %>%
  filter(Characteristics == 'Percent') %>%
  group_by(Sex, Age.group, Measures) %>%
  summarise(VALUE, .groups = 'drop') %>% 
  spread(Measures, VALUE)

#clean the covid cases data by age and gender
cleaned_data <- Covid_aG %>%
  select(-rate_per_100000) %>%
  filter(status != 'deaths', 
         age_group != 'all', 
         gender != 'all',
         gender != 'other') %>%
  na.omit()

#match the age groups categories with longterm
map_age_group <- function(age_group) {
  case_when(
    age_group %in% c("20 to 29", "30 to 39") ~ "Ages 18 to 34",
    age_group %in% c("40 to 49") ~ "Ages 35 to 49",
    age_group %in% c("50 to 59", "60 to 69") ~ "Ages 50 to 64",
    age_group %in% c("70 to 79", "80+") ~ "Ages 65 and over",
    TRUE ~ NA_character_ 
  )
}

#match the sex categories
summary_data <- cleaned_data %>%
  mutate(age_group = map_age_group(age_group)) %>%
  mutate(gender = case_when(
    gender == 'male' ~ 'Males',
    gender == 'female' ~ 'Females',
    TRUE ~ gender
  )) %>%
  filter(!is.na(age_group)) %>%
  group_by(gender,age_group) %>%
  summarise(count = sum(count), .groups = 'drop')

#total for ages
ages_18_and_over <- summary_data %>%
  group_by(gender) %>%
  summarise(count = sum(count), .groups = 'drop') %>%
  mutate(age_group = 'Ages 18 and over')

summary_data <- bind_rows(summary_data, ages_18_and_over)

#both sexes
both_sexes_data <- summary_data %>%
  filter(gender %in% c('Males', 'Females')) %>%
  group_by(age_group) %>%
  summarise(count = sum(count), .groups = 'drop') %>%
  mutate(gender = 'Both sexes')

final_summary_data <- rbind(summary_data, both_sexes_data)
final_summary_data <- final_summary_data %>%
  arrange(gender, age_group) %>%
  rename(Sex = gender, Age.group = age_group)

#combine longterm proportion data with the group counts
combined_data <- left_join(grouped_data, final_summary_data, by = c("Sex", "Age.group"))
```

The data is first grouped by sex which consists of "males", "females", and "Both sexes". "Both sexes" group contain the combined data from both males and females. Then the data is further grouped by age groups. Subgroup "Ages 18 and over" has the total count for the corresponding sex group. The proportion table with total count of subgroups is shown in the Table 3.2.1 below.
```{r}
gt_table <- combined_data %>%
  gt() %>%
  tab_header(
    title = md("**Table 3.2.1:Combined Data Showing Proportions and Counts by Sex and Age**")
  ) %>%
  cols_label(
    Sex = "Sex",
    `Age.group` = "Age Group",
    `Yes, had long-term symptoms` = "Yes, had long-term symptoms (Percent)",
    `No, did not have long-term symptoms` = "No, did not have long-term symptoms (Percent)",
    count = "Count"
  ) %>%
  tab_style(
    style = list(
      cell_borders(sides = "bottom", weight = px(2))
    ),
    locations = cells_body(
      rows = combined_data$Sex != dplyr::lead(combined_data$Sex)
    )
  ) %>%
  tab_style(
    style = list(
      cell_fill(color = "lightgrey"), 
      cell_text(weight = "bold")
    ),
    locations = cells_column_labels(columns = TRUE)
  ) %>%
  tab_style(
    style = cell_text(align = "center"), 
    locations = cells_body(columns = c(3,4))
  )

invisible(print(gt_table))
```
From the Table 3.2.1, we find that for females, higher proportion(24.4%) of respondents from age 65 and over reported long term symptoms. While males from ages 18 to 34 show a higher proportion(13%) to report long term symptoms. Overall(both sexes), higher proportion(17.8%) of adults from ages 65 and over reported long term symptoms. For all age groups, 20.1% of females reported long term symptoms comparing to only 12% of males.

To study the association between age groups and the long term symptoms, A Chi-square test was conducted within each sex group. The hypothesis of independence corresponds to $H_0:p_{ij}=p_{i\cdot}p_{\cdot j}, \forall i,j$. Under each sex group, a $4\times2$ contingency is constructed. We have age groups as the row variable , response of long term symptoms as the column variable. Counts for specific responses "Yes, had long-term symptoms" and "No, did not have long-term symptoms" are estimated using the corresponding proportion and the total counts of each subgroup. 

A similar Chi-square test was applied to test the association between sex and the long term symptoms. Under each age group, a $2\times2$ contingency table is constructed with sex as the row variable and long term symptoms as the column variable. 

Test results are shown in the following table.
```{r}
library(broom)
perform_chi_square1 <- function(data) {
  filtered_data <- data %>% 
    filter(`Age.group` != "Ages 18 and over")

  contingency_table <- filtered_data %>%
    select(`Age.group`, `Yes, had long-term symptoms`, count) %>%
    mutate(No = round((100 - `Yes, had long-term symptoms`) * count / 100),
           Yes = round(`Yes, had long-term symptoms` * count / 100)) %>%
    select(-`Yes, had long-term symptoms`,-`count`) %>%
    group_by(`Age.group`)

  chi_square_result <- chisq.test(contingency_table[-1])
  
  return(chi_square_result)
}

results1 <- list()
sexes <- c("Males", "Females", "Both sexes")
for (sex in sexes) {
  filtered_data <- combined_data %>% filter(Sex == sex)
  results1[[sex]] <- perform_chi_square1(filtered_data)
}

test_results1 <- lapply(results1, tidy) %>% bind_rows() %>% mutate(Sex = sexes)
test_results1 <- select(test_results1, Sex, statistic, p.value)

significance_level <- 0.05

result_table1 <- test_results1 %>%
  gt() %>%
  tab_header(
    title = md("**Table 3.2.2: Chi-Squared Test Results of Age groups and Long term symptoms**")
  ) %>%
  cols_label(
    Sex = "Sex",
    statistic = "Chi-Squared Statistic",
    p.value = "P-Value"
  ) %>%
  fmt_number(
    columns = vars(statistic, p.value),
    decimals = 3
  ) %>%
  fmt(
    columns = vars(p.value),
    fns = function(x) {
      ifelse(x < significance_level, paste("<", significance_level), sprintf("%.3f", x))
    }
  )

invisible(print(result_table1))
```
Table 3.2.2 shows the results of Chi-squared tests comparing the Occurrence of long-term COVID-19 symptoms across different age groups within each sex category and for both sexes combined.For all categories (Males, Females, and Both Sexes), the Chi-squared statistics are high, and the p-values are less than 0.05.This suggests that within each of these categories, there is a statistically significant association between age group and the occurrence of long-term COVID-19 symptoms. The differences in symptom frequencies across age groups are not likely to be due to random chance.

```{r}
perform_chi_square2 <- function(data, age_group) {
  filtered_data <- data %>%
    filter(`Age.group` == age_group, Sex != "Both sexes")

  contingency_table <- filtered_data %>%
    select(Sex, `Yes, had long-term symptoms`, count) %>%
    mutate(No = round((100 - `Yes, had long-term symptoms`) * count / 100),
           Yes = round(`Yes, had long-term symptoms` * count / 100)) %>%
    select(-`Yes, had long-term symptoms`,-`count`) %>%
    group_by(Sex)

  chi_square_result <- chisq.test(contingency_table[-1])

  return(chi_square_result)
}

age_groups <- unique(combined_data$Age.group)

results2 <- list()
for (age in age_groups) {
  results2[[age]] <- perform_chi_square2(combined_data, age)
}

test_results2 <- lapply(results2, tidy) %>% bind_rows() %>% mutate(`Age.group` = age_groups)
test_results2 <- select(test_results2, `Age.group`, statistic, p.value)

result_table2 <- test_results2 %>%
  gt() %>%
  tab_header(
    title = md("**Table 3.2.3: Chi-Squared Test Results of Sex and Long term symptoms**")
  ) %>%
  cols_label(
    `Age.group` = "Age Group",
    statistic = "Chi-Squared Statistic",
    p.value = "P-Value"
  ) %>%
  fmt_number(
    columns = vars(statistic),
    decimals = 3
  ) %>%
  fmt(
    columns = vars(p.value),
    fns = function(x) {
      ifelse(x < 0.05, paste("< 0.05"), sprintf("%.3f", x))
    }
  )

invisible(print(result_table2))
```
Table 3.2.3 presents the results of Chi-squared tests comparing the occurrence of long-term COVID-19 symptoms between males and females within each age group.Each age group shows a very high Chi-squared statistic with all p-values being less than 0.05. These results indicate a statistically significant association between sex and the occurrence of long-term COVID-19 symptoms in each age group.

To further explore the strength of the association. We calculated odds ratios primarily between males and females in each age group. For each age group, the odds of females experiencing long-term symptoms are compared to the odds for males. An OR greater than 1 indicates a higher likelihood for females. The results are shown in Table 3.2.4.
```{r}
contingency_tables <- combined_data %>%
  #filter(`Age.group` != "Ages 18 and over") %>%
  filter( Sex != "Both sexes") %>%
  select(`Sex`, `Age.group`, `Yes, had long-term symptoms`, count) %>%
  mutate(No = round((100 - `Yes, had long-term symptoms`) * count / 100),
         Yes = round(`Yes, had long-term symptoms` * count / 100)) %>%
  select(-`Yes, had long-term symptoms`, -count) %>%
  pivot_longer(cols = c("Yes", "No"), names_to = "Response", values_to = "Count") %>%
  group_by(`Age.group`, `Sex`, Response) %>%
  ungroup() %>%
  pivot_wider(names_from = "Response", values_from = "Count")

contingency_tables <- contingency_tables %>%
  mutate(Odds = Yes / No)

odds_ratios <- contingency_tables %>%
  group_by(Age.group) %>%
  summarise(OddsRatio = Odds[Sex == "Females"] / Odds[Sex == "Males"]) %>%
  ungroup()

OR_table <- odds_ratios %>%
  gt() %>%
  tab_header(
    title = md("**Table 3.2.4: Odds Ratios of Long-term COVID-19 Symptoms: Females vs Males by Age Group**")
  ) %>%
  cols_label(
    Age.group = "Age Group",
    OddsRatio = "Odds Ratio"
  ) %>%
  fmt_number(
    columns = vars(OddsRatio),
    decimals = 3
  )

invisible(print(OR_table))

```
Across all age groups, females are consistently more likely than males to report long-term COVID-19 symptoms, as indicated by odds ratios greater than 1 in each category. The odds ratios seem to increase with age. The highest disparity between females and males is observed in the oldest age group (Ages 65 and over).

## Prevalence Modeling

The hypothesis we were mostly interested in was:

\begin{gather*}
H_0: \beta_j = 0 \\
H_0: \beta_j \neq 0
\end{gather*}

for each coefficient related to its corresponding covariate. In other words, we wanted to describe the relationship between the COVID status of a participant and other predictors. We selected the model with the least AIC value shown in Table 3.3.1.
```{r}
Xy<-RegressionData[,2:14]%>%mutate(y=RegressionData$Covid_Status)%>%na.omit()
Models<-bestglm(Xy,family=binomial,IC=c("AIC")) 
```

```{r}
fits<-t(rbind(Models$Subsets[,1:14], n=colSums(Models$Subsets[,1:14])))
fits<-cbind(as.data.frame(fits[order(fits[,"n"], decreasing = TRUE),-15]%>%t()), Models$Subsets[,15:16])

fits%>%gt()%>%tab_header(
    title = "Table 3.3.1: Complete List of Models For COVID Status Estimation")%>%tab_options(container.width = 1400, table.align="left")%>%
  tab_style(style = list(cell_fill(color = "lightblue")), locations = cells_body(rows = 5))
```

Our best model had the following coefficients shown in the summary Table 3.3.2, from which we found that the variable FluVac that indicated whether or not the participant had a flu shot for the past 12 months had a p-value = 0.155 not significant enough, so we did not have a conclusion on whether the variable was associated with the response.

```{r}
Models$BestModel%>%stargazer(type = "text", title="Table 3.3.2: Summary of Model with Lowest AIC", dep.var.labels = c("Covid\\_Status"), report=("vc*s*p"))
```

We looked at the AIC when the flu vaccine status variable was removed. One can see in Table 3.3.3 below that there was not much difference in the AIC value. For model simplicity we therefore omitted the variable. 

```{r}
Models$BestModels[1:2,]%>%gt()%>%tab_header(
    title = "Table 3.3.3: Model AIC Comparison with FluVac Removed")%>%tab_options(container.width = 1400, table.align="left")%>%
  tab_style(style = list(cell_fill(color = "lightblue")), locations = cells_body(columns=FluVac))
```

Similarly, from summary Table 3.3.2 above we found that the variable DirectContact that showed whether the participant had directed contact with people or not also had an unpromising p-value=0.053. After removing the FluVac variable first, we compared the models with and without DirectContact variable using the deviance. From the following summary Table 3.3.4 one can see that the p-value of the Chi-squared statistic was 0.085, suggesting again that we did not have a conclusion whether or not there was an association between the COVID status and having direct contact with people.

```{r}
fit1<-glm(y~DirectContact+VaccineStatus+AntiBodyResult, data=Xy, family = "binomial")
fit2<-glm(y~VaccineStatus+AntiBodyResult, data=Xy, family = "binomial")
tbls<-anova(fit1, fit2, test="LRT")
notes<-strsplit(attr(tbls, "heading")[2], "\n")
tbls%>%stargazer(type = "text", title="Table 3.3.4: Validation of DirectContact Variable",notes=notes[[1]],summary=FALSE)
```

We again dropped the variable DirectContact because the AIC didn't change significantly after removal:
```{r}
Models$Subsets[3:4,]%>%gt()%>%tab_header(
    title = "Table 3.3.5: Model AIC Comparison with DirectContact Removed")%>%tab_options(container.width = 1400, table.align="left")%>%
  tab_style(style = list(cell_fill(color = "lightblue")), locations = cells_body(columns=DirectContact))
```

Therefore, we concluded that our model was:
\begin{equation*}
\ln{(\frac{p_i}{1-p_i})} = -5.565 -4.568 \times \text{VaccineStatusYes}_i +3.392 \times \text{AntiBodyResultIndeterminate}_i +6.602 \times \text{AntiBodyResultPositive}_i
\end{equation*}

from the following summary Table 3.3.6:
```{r}
fit2%>%stargazer(type = "text", title="Table 3.3.6: Summary of Final Model", dep.var.labels = c("Covid\\_Status"), report=("vc*s*p"))
```

We further did another model estimation for the COVID status and some preventative behaviours like washing hands, wearing masks, keep 2 metres and avoiding crowds. The result in summary Table 3.3.7 showed that only washing hands often an always were significant enough to be negatively related to the COVID status whereas all other covariates were inconclusive.

```{r}
Xy2<-RegressionData%>%select(Covid_Status, WashHand, WearMask, Keep2m, AvoidCrowds)%>%na.omit()
glm(Covid_Status~WashHand+WearMask+Keep2m+AvoidCrowds, data=Xy2, family = "binomial")%>%
  stargazer(type = "text", title="Table 3.3.7: Model Estimates of COVID Status with Preventative Behaviours",dep.var.labels = c("Covid\\_Status"), report=("vc*s*p"))
```

# Discussion

## Mortality
From Section 3.1, we found that the probability of death caused by COVID-19 is not homogeneous across years, then we computed the relative risks and odds ratios for 2021,2022 and 2023. We observed that relative risk in 2022 (RR = 1.1714) indicates a higher risk compared to the 2020, while relative risk in 2021 (RR = 0.9449) suggests a slightly lower risk. Notably, relative risk in 2023 (RR = 0.4714) stands out with a significantly lower risk, suggesting a potential protective effect. The odds ratio in 2023 (OR = 2.179) stands out, indicating a significantly higher odds compared to the odds in 2020. In contrast, odds ratio in 2022 (OR = 0.8461) suggests a lower odds, while odds ratio in 2021 (OR = 1.0613) demonstrates a subtle increase.

The lower risk and higher odds in 2021 and 2023 might because the widespread vaccination in Canada. Public Health Ontario states[@PHO] that over 70.2% of Ontario residents received at least one dose of COVID-19 vaccine in the full year 2021, over 60% completed two doses vaccination. Also, the vaccine still has high vaccine effectiveness against variants of concern Alpha and delta. Till October 2023, 80.5% people in total population in Canada completed their primary series vaccination, over 4 million people received booster dose  Pfizer-BioNTech Comirnaty vaccine[@VC]. The public health restrictions and mandatory masking policies dropped, there has also been a shift from the young to the old, with more than 80% of deaths occurring in patients over 65 years old with comorbidities[@CBC].

## Long-term Impact

Based on the results from section 3.2, The Chi-squared tests revealed statistically significant associations between age groups and the occurrence of long-term COVID-19 symptoms within each sex category and between sexes within each age group. The Odds Ratios consistently showed that females are more likely than males to report long-term COVID-19 symptoms in all age groups.This disparity in the likelihood of symptoms appears to increase with age, with the oldest age group (Ages 65 and over) showing the highest Odds Ratio.

Our findings resonate with several clinical studies that have suggested gender difference in the impact of long_COVID-19 syndrome.Specifically, the higher likelihood of long-term symptoms in females is consistent with public health researches that women might experience COVID-19 differently than men.[@Bai2021-vb] However our study is based on aggregated data focusing primarily on the association of sex and age with long-term COVID-19 symptoms. While this provides valuable insights, the data does not include individual patient states that could influence the findings. Moreover, The nature of the data and the analytical methods used (Chi-squared tests and Odds Ratios) are effective for identifying associations but do not establish causation. 

Further studies involving more detailed data should aim to uncover the biological, social, and behavioral mechanisms driving the observed gender differences in long-term COVID-19 symptoms. Some study[@Juszko2022-oq] suggests that psychological factors also have correlation in both women and men with self-reported health after COVID-19. The study clearly indicates a significant gender disparity in the mental health impact of COVID-19 during the recuperation period.

## Prevalence Modeling

From Section 3.3 we have found that the odds ratio of COVID-19 was related to two covariates: the vaccination status and the antibody presented in blood. Specifically, we interpreted the coefficients as the log-odds for its corresponding covariate. 

$$
\ln{OR}=\beta_j, \quad OR:=\frac{p_2(1-p_1)}{p_1(1-p_2)}
$$

In other words, $e^{\beta_j}$ is the marginal increase/decrease in the odds for a on-unit increase/decrease in the covariate, assuming all other covariates held constant. On the other hand, the constant coefficient $\beta_0$ is interpreted as the log-odds $\ln{(\frac{p_1}{1-p_1})}$ with all covariates unchanged. From our summary Table 3.3.6 one can see that the coefficient for the vaccine status was negative, indicating that the odds of having a positive COVID test decreases if vaccine was given. This result wasn't surprising that the use of vaccines has so far helped the humanity combat this virus. The coefficient for the indeterminate antibody result was positive, and the one for the positive antibody result was even higher. We must point out that one needs to carefully interpret this result. It meant that the odds of getting a positive COVID test is positively correlated with the result of an antibody test. The more positive the antibody test is, the higher the odds of having a positive COVID test as well. However, antibody test and the COVID-19 diagnostic test are not the same thing in the explainations provided by FDA [@Antibody]. The antibody test does not detect the virus. Rather, it merely tells if a person may have had a PRIOR infection, thus it does not reflect if the person is currently infected or not. In addition, the antibody test could show if a person has been vaccinated or not, but in general an antibody test may not detect the kind of antibodies created by vaccines, therefore it depends on the type of antibody test performed. From our result we were only able to say that there was a positive relationship between the COVID diagnostic test and the antibody test, which was not surprising because in order to show positive in an antibody test, one must have had COVID to begin with. This information may be useful, for example, that one of the tests is economically more affordable and can be used as a preliminary screening method.

From the second model fitting for preventative behaviours, we found that only washing hand was showing a negative effect on the odds of getting COVID. We weren't able to draw any conclusion for other preventative behaviours, but we thought it was inevitably hard to find a relationship between the COVID status and those behaviours because people may not answer the questionnaire accurately. People might find difficult to distinguish the boundary between wearing mask often and always. People can even falsely answer that they keep a distance of 2 metres or more but in reality they have not done so. The resulting answers for the survey therefore may not be as reliable. Thus we thought it is generally difficult to accurately describe the relationship between prevalence of disease and preventative behaviour. Researchers have to design experiments and find ways to quantify the behaviour in order to have more reliable outcomes. 

# Conclusion
In Mortality section, we found that there exist significant difference in  probability of death caused by COVID-19 across years. 2022 has the relative risk greater than 1 and odds ratio less than 1, which indicate the negative association, indicating an decreased likelihood of the in probability in COVID-19 death in these years.Given the change in the demographic of the affected population, it is essential to acknowledge the possibility that the rise in mortality among older individuals in the later stages of the epidemic could be attributed to complications rather than the direct impact of COVID-19 itself. In future research, it would be valuable to explore the influence of complications on the death after infections.

we can conclude that there is a significant association between age and gender with the occurrence of long-term COVID-19 symptoms. Notably, females across all age groups, especially those aged 65 and over, are more likely to report these symptoms compared to males.However, it's important to recognize that our study, while highlighting crucial associations, does not delve into the causal mechanisms due to its reliance on aggregated data. This limitation underscores the need for further research with more comprehensive data to explore the underlying biological, social, and psychological factors contributing to these observed differences in long-term COVID-19 symptoms.

We found in Prevalence Modeling section that the COVID status is negatively associated with the vaccination status, indicating that vaccines was a significant factor to lower the prevalence of the virus. We also found but not surprising that the antibody test result was positively related to the COVID status. In addition, we did confirm that washing hands can result in a negative influence on the prevalence of COVID, but we could not find the same conclusion for other preventative behaviours.

# References
