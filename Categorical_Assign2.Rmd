---
title: "MAT5317 Categorical Assignment 2"
author:
- Teng Li(7373086)
- Zhize Lu(300075114)
- Chutong Zhang(300311325)
output: 
  html_notebook: 
    toc: yes
    number_sections: yes
    fig_caption: yes
header-includes:
- \renewcommand{\and}{\\}
- \usepackage{float}
- \floatplacement{figure}{H}
bibliography: References.bib
link-citations: yes
---

<style type="text/css">
.title, .author{text-align: center;}
body{font-size: 12pt;}
table{font-size: 12pt;}
h1{font-size: 14pt;}
h2{font-size: 12pt;}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(plotly)
library(bestglm)
library(gt)
library(stargazer)
```

```{r}
CCAHS<-read.csv("CCAHS.csv", header = TRUE)
Covid<-read.csv("Covid.csv", header = TRUE)
Covid_aG<-read.csv("COVID_cases.csv", header = TRUE)
WMortality<-read.csv("WeeklyMortality.csv", header = TRUE)
ExMortality<-read.csv("ExcessMortality.csv", header = TRUE)
LongTerm<-read.csv("LongTerm.csv", header = TRUE)
```

# Introduction

The COVID-19 pandemic, caused by the novel coronavirus SARS-CoV-2, has had an unprecedented impact on global health, economies, and daily life since its emergence in late 2019. As the world fights with the challenges posed by this highly contagious virus, epidemiological data have been continuously gathered and released to the public, driving numerous researches and different approaches in trying to understand its patterns of transmission, to identify vulnerable populations, and to inform public health strategies. Due to the severity of the early stage of the pandemic and its wide impact on global production, data of high quality and accuracy were gathered in the nation through surveys and reports, so we believed that the COVID-19 data sets could be more informative and extensive than other epidemiology data.

In this assignment, we looked into the COVID-19 epidemiology data sets provided by Statistics Canada along with other related data sets. We attempted to answer three major questions in three subsections:

1. We wanted to find if there was a possible relationship between the COVID pandemic and the excess mortality for 2020, 2021 and 2022. Through this question, one might be able to draw insights on whether the virus has had a dangerous impact on the overall public health.

2. We gathered data of COVID-19 long term symptom among Canadian adults. We wanted to draw some conclusions on whether the virus had any impact on the long-term health condition of Canadians.

3. We wanted to measure the relationship between the risk prevalence and some factors like vaccination status, chronic conditions and having or not a direct contact with people etc. By building a statistical model between the response and predictors, it helped us understand what procedures or conditions can affect the prevalence of COVID-19.  

# Method

## Section 1: Mortality

## Section 2: Long-term Impact

The data of COVID-19 long term symptom among Canadian adults contain the major variables shown in the following table. We mainly interested in the Measures which is the response variable. The data is grouped by sex and age groups. The value shows the percentage of responses within each specific group.The original data provided the confidence intervals in the assessment of point estimates in case of high variability in the data. 

```{r}
DataDict_data <- LongTerm[,c(1,2,4,5,6,7,8,14,18)]

DataDict<-data.frame(
  Variables=colnames(DataDict_data),   
  Type=sapply(DataDict_data, function(x) class(x)),
  Example=sapply(DataDict_data, function(x) paste(as.character(head(unique(x),2)), collapse = ", ")),
  Number.Unique=sapply(DataDict_data, function(x) length(unique(x))),
  PctMissing=sapply(DataDict_data, function(x) paste0(round(sum(is.na(x))/length(x), 4)*100,"%")),
  Comment=c("Reference Year (2022)",
                  "Geographic Location (Canada)",
                  "Does the respondent have the long term symptoms? Yes or No.",
                  "Sex Category",
                  "Age Groups",
                  "Characteristics of the value, estimate or confidence interval",
                  "Unit of Measure (Percentage of the group)",
                  "Data Value",
                  "Number of Decimal Places in Value")
)
DataDict%>%gt()%>%tab_header(
    title = "Table (): Long Term Symptoms Data Definition")
```

As the data of COVID-19 long term symptom among Canadian adults did not contain the population size and population for each groups. We estimate the counts from the data of Weekly number of COVID-19 cases in Canada as of October 28, 2023. From the data of overall COVID-19 cases, we first grouped the data to the similar structure as our Long Term Symptom data. The data of other genders was dropped because that the count is too small comparing to the total population.
```{r}
#group the longterm data and drop variables not used in the analysis
grouped_data <- LongTerm %>%
  filter(Characteristics == 'Percent') %>%
  group_by(Sex, Age.group, Measures) %>%
  summarise(VALUE, .groups = 'drop') %>% 
  spread(Measures, VALUE)

#clean the covid cases data by age and gender
cleaned_data <- Covid_aG %>%
  select(-rate_per_100000) %>%
  filter(status != 'deaths', 
         age_group != 'all', 
         gender != 'all',
         gender != 'other') %>%
  na.omit()

#match the age groups categories with longterm
map_age_group <- function(age_group) {
  case_when(
    age_group %in% c("20 to 29", "30 to 39") ~ "Ages 18 to 34",
    age_group %in% c("40 to 49") ~ "Ages 35 to 49",
    age_group %in% c("50 to 59", "60 to 69") ~ "Ages 50 to 64",
    age_group %in% c("70 to 79", "80+") ~ "Ages 65 and over",
    TRUE ~ NA_character_ 
  )
}

#match the sex categories
summary_data <- cleaned_data %>%
  mutate(age_group = map_age_group(age_group)) %>%
  mutate(gender = case_when(
    gender == 'male' ~ 'Males',
    gender == 'female' ~ 'Females',
    TRUE ~ gender
  )) %>%
  filter(!is.na(age_group)) %>%
  group_by(gender,age_group) %>%
  summarise(count = sum(count), .groups = 'drop')

#total for ages
ages_18_and_over <- summary_data %>%
  group_by(gender) %>%
  summarise(count = sum(count), .groups = 'drop') %>%
  mutate(age_group = 'Ages 18 and over')

summary_data <- bind_rows(summary_data, ages_18_and_over)

#both sexes
both_sexes_data <- summary_data %>%
  filter(gender %in% c('Males', 'Females')) %>%
  group_by(age_group) %>%
  summarise(count = sum(count), .groups = 'drop') %>%
  mutate(gender = 'Both sexes')

final_summary_data <- rbind(summary_data, both_sexes_data)
final_summary_data <- final_summary_data %>%
  arrange(gender, age_group) %>%
  rename(Sex = gender, Age.group = age_group)

#combine longterm proportion data with the group counts
combined_data <- left_join(grouped_data, final_summary_data, by = c("Sex", "Age.group"))
```

The data is first grouped by sex which consists of "males", "females", and "Both sexes". "Both sexes" group contain the combined data from both males and females. Then the data is further grouped by age groups. Subgroup "Ages 18 and over" has the total count for the corresponding sex group. The data is shown in the Table()
```{r}
gt_table <- combined_data %>%
  gt() %>%
  tab_header(
    title = md("**Table ():Combined Data Showing Proportions and Counts by Sex and Age**")
  ) %>%
  cols_label(
    Sex = "Sex",
    `Age.group` = "Age Group",
    `Yes, had long-term symptoms` = "Yes, had long-term symptoms (Percent)",
    `No, did not have long-term symptoms` = "No, did not have long-term symptoms (Percent)",
    count = "Count"
  ) %>%
  tab_style(
    style = list(
      cell_borders(sides = "bottom", weight = px(2))
    ),
    locations = cells_body(
      rows = combined_data$Sex != dplyr::lead(combined_data$Sex)
    )
  ) %>%
  tab_style(
    style = list(
      cell_fill(color = "lightgrey"), 
      cell_text(weight = "bold")
    ),
    locations = cells_column_labels(columns = TRUE)
  ) %>%
  tab_style(
    style = cell_text(align = "center"), 
    locations = cells_body(columns = c(3,4))
  )

invisible(print(gt_table))
```
From the Table(), we find that for females, higher proportion(24.4%) of respondents from age 65 and over reported long term symptoms. While males from ages 18 to 34 show a higher proportion(13%) to report long term symptoms. Overall(both sexes), higher proportion(17.8%) of adults from ages 65 and over reported long term symptoms. For all age groups, 20.1% of females reported long term symptoms comparing to only 12% of males.

To study the association between age groups and the long term symptoms, A Chi-square test was conducted within each sex group. The hypothesis of independence corresponds to $H_0:p_{ij}=p_{i\cdot}p_{\cdot j}, \forall i,j$. Here under each sex group, we have row variable as the age groups,  column variable as the response of long term symptoms. Counts for specific responses "Yes, had long-term symptoms" and "No, did not have long-term symptoms" are estimated using the corresponding proportion and the total counts of each subgroup. Test results are shown in the following table.
```{r}
library(broom)
perform_chi_square1 <- function(data) {
  filtered_data <- filter(data, `Age.group` != "Ages 18 and over")

  contingency_table <- filtered_data %>%
    select(`Age.group`, `Yes, had long-term symptoms`, count) %>%
    mutate(No = (100 - `Yes, had long-term symptoms`) * count / 100,
           Yes = `Yes, had long-term symptoms` * count / 100) %>%
    select(-`Yes, had long-term symptoms`) %>%
    group_by(`Age.group`)

  chi_square_result <- chisq.test(contingency_table[-1])
  
  return(chi_square_result)
}

results1 <- list()
sexes <- c("Males", "Females", "Both sexes")
for (sex in sexes) {
  filtered_data <- combined_data %>% filter(Sex == sex)
  results1[[sex]] <- perform_chi_square1(filtered_data)
}

test_results1 <- lapply(results1, tidy) %>% bind_rows() %>% mutate(Sex = sexes)
test_results1 <- select(test_results1, Sex, statistic, p.value)

significance_level <- 0.05

result_table1 <- test_results1 %>%
  gt() %>%
  tab_header(
    title = md("**Table():Chi-Squared Test Results of Age groups and Long term symptoms**")
  ) %>%
  cols_label(
    Sex = "Sex",
    statistic = "Chi-Squared Statistic",
    p.value = "P-Value"
  ) %>%
  fmt_number(
    columns = vars(statistic, p.value),
    decimals = 3
  ) %>%
  fmt(
    columns = vars(p.value),
    fns = function(x) {
      ifelse(x < significance_level, paste("<", significance_level), sprintf("%.3f", x))
    }
  )

invisible(print(result_table1))
```
```{r}
perform_chi_square2 <- function(data, age_group) {
  filtered_data <- data %>%
    filter(`Age.group` == age_group, Sex != "Both sexes")

  contingency_table <- filtered_data %>%
    select(Sex, `Yes, had long-term symptoms`, count) %>%
    mutate(No = (100 - `Yes, had long-term symptoms`) * count / 100,
           Yes = `Yes, had long-term symptoms` * count / 100) %>%
    select(-`Yes, had long-term symptoms`) %>%
    group_by(Sex) %>%
    summarise(No = sum(No), Yes = sum(Yes))

  chi_square_result <- chisq.test(contingency_table[-1])

  return(chi_square_result)
}

age_groups <- unique(combined_data$`Age.group`[combined_data$`Age.group` != "Ages 18 and over"])

results2 <- list()
for (age_group in age_groups) {
  results2[[age_group]] <- perform_chi_square2(combined_data, age_group)
}

test_results2 <- lapply(results2, tidy) %>% bind_rows() %>% mutate(`Age.group` = age_groups)
test_results2 <- select(test_results2, `Age.group`, statistic, p.value)

result_table2 <- test_results2 %>%
  gt() %>%
  tab_header(
    title = md("**Table():Chi-Squared Test Results of Sex and Long term symptoms**")
  ) %>%
  cols_label(
    `Age.group` = "Age Group",
    statistic = "Chi-Squared Statistic",
    p.value = "P-Value"
  ) %>%
  fmt_number(
    columns = vars(statistic),
    decimals = 3
  ) %>%
  fmt(
    columns = vars(p.value),
    fns = function(x) {
      ifelse(x < 0.05, paste("< 0.05"), sprintf("%.3f", x))
    }
  )

invisible(print(result_table2))
```
prop test? fisher test? G-test?

## Section 3: Prevalence Modeling

# Result

## Section 1: Mortality

## Section 2: Long-term Impact

## Section 3: Prevalence Modeling

```{r}
WMortality%>%mutate(Year=year(REF_DATE), Week=substr(REF_DATE,6,10))%>%mutate(Year=factor(Year))%>%filter(Age.at.time.of.death=="Age at time of death, all ages" & Sex=="Both sexes" & GEO=="Canada, place of occurrence")%>%
  plot_ly(x=~Week, y=~VALUE, color=~Year,type = "scatter", mode="lines")
```

# Discussion

## Section 1: Mortality

## Section 2: Long-term Impact

## Section 3: Prevalence Modeling

# Conclusion

# References
