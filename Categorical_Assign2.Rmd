---
title: "MAT5317 Categorical Assignment 2"
author:
- Teng Li(7373086)
- Zhize Lu(300075114)
- Chutong Zhang(300311325)
output: 
  bookdown::html_document2:
    toc: true
header-includes:
- \renewcommand{\and}{\\}
- \usepackage{float}
- \floatplacement{figure}{H}
bibliography: References.bib
link-citations: yes
---

<style type="text/css">
.title, .author{text-align: center;}
body{font-size: 12pt;}
table{font-size: 12pt;}
h1{font-size: 14pt;}
h2{font-size: 12pt;}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
library(tidyverse)
library(plotly)
library(kableExtra)
```

```{r}
CCAHS<-read.csv("CCAHS.csv", header = TRUE)
Covid<-read.csv("Covid.csv", header = TRUE)
WMortality<-read.csv("WeeklyMortality.csv", header = TRUE)
ExMortality<-read.csv("ExcessMortality.csv", header = TRUE)
LongTerm<-read.csv("LongTerm.csv", header = TRUE)
AgeGenderTotal<-read.csv("CovidAgeGender.csv", header = TRUE)
```

# Introduction

The COVID-19 pandemic, caused by the novel coronavirus SARS-CoV-2, has had an unprecedented impact on global health, economies, and daily life since its emergence in late 2019. As the world fights with the challenges posed by this highly contagious virus, epidemiological data have been continuously gathered and released to the public, driving numerous researches and different approaches in trying to understand its patterns of transmission, to identify vulnerable populations, and to inform public health strategies. Due to the severity of the early stage of the pandemic and its wide impact on global production, data of high quality and accuracy were gathered in the nation through surveys and reports, so we believed that the COVID-19 data sets could be more informative and extensive than other epidemiology data.

In this assignment, we looked into the COVID-19 epidemiology data sets provided by Statistics Canada along with other related data sets. We attempted to answer three major questions in three subsections:

1. We wanted to find if there was a possible relationship between the COVID pandemic and the excess mortality for 2020, 2021 and 2022. Through this question, one might be able to draw insights on whether the virus has had a dangerous impact on the overall public health.

2. We gathered data of COVID-19 long term symptom among Canadian adults. We wanted to draw some conclusions on whether the virus had any impact on the long-term health condition of Canadians.

3. We wanted to measure the relationship between the risk prevalence and some factors like vaccination status, chronic conditions and having or not a direct contact with people etc. By building a statistical model between the response and predictors, it helped us understand what procedures or conditions can affect the prevalence of COVID-19.  

# Method

## Section 1: Mortality

## Section 2: Long-term Impact

The data of COVID-19 long term symptom among Canadian adults contain the major variables shown in the following table. We mainly interested in the Measures which is the response variable. The data is grouped by sex and age groups. The value shows the percentage of responses within each specific group.
```{r}
data_dictionary <- data.frame(
  Variable = c("REF_DATE", "GEO", "Measures", "Sex", "Age group","Characteristics", "UOM", "VALUE", "DECIMALS"),
  Type = c("Categorical", "Categorical", "Categorical", "Categorical", "Categorical", "Categorical", "Categorical", "Numerical", "Numerical"),
  Description = c("Reference Year (2022)", "Geographic Location (Canada)", "Type of Measure (e.g., 'Yes, had long-term symptoms')", "Sex Category (e.g., Both sexes, Male, Female)", "Age Groups (e.g., Ages 18 and over, Ages 18 to 34)", "Percentage, Low/High 95% Confidence interval percentage", "Unit of Measure (Percentage of the group)", "Data Value", "Number of Decimal Places in Value")
)

# Create HTML table
kable(data_dictionary, "html") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```
```{r}
grouped_data <- LongTerm %>%
  filter(Characteristics == 'Percent') %>%
  group_by(Sex, Age.group, Measures) %>%
  summarise(VALUE, .groups = 'drop') %>% 
  spread(Measures, VALUE)
```

As the data of COVID-19 long term symptom among Canadian adults did not contain the population size and population for each groups. We estimate the counts from the data of Weekly number of COVID-19 cases in Canada as of October 28, 2023. From the data of overall COVID-19 cases, we first grouped the data to the similar structure as our Long Term Symptom data. The data of other genders was dropped because that the count is too small comparing to the total population.
```{r}
cleaned_data <- AgeGenderTotal %>%
  select(-rate_per_100000) %>%
  filter(status != 'deaths', 
         age_group != 'all', 
         gender != 'all',
         gender != 'other') %>%
  na.omit()

map_age_group <- function(age_group) {
  case_when(
    age_group %in% c("20 to 29", "30 to 39") ~ "Ages 18 to 34",
    age_group %in% c("40 to 49") ~ "Ages 35 to 49",
    age_group %in% c("50 to 59", "60 to 69") ~ "Ages 50 to 64",
    age_group %in% c("70 to 79", "80+") ~ "Ages 65 and over",
    TRUE ~ "Ages 18 and over" 
  )
}


summary_data <- cleaned_data %>%
  mutate(age_group = map_age_group(age_group)) %>%
  mutate(gender = case_when(
    gender == 'male' ~ 'Males',
    gender == 'female' ~ 'Females',
    TRUE ~ gender
  )) %>%
  group_by(gender,age_group) %>%
  summarise(count = sum(count), .groups = 'drop')

both_sexes_data <- summary_data %>%
  filter(gender %in% c('Males', 'Females')) %>%
  group_by(age_group) %>%
  summarise(count = sum(count), .groups = 'drop') %>%
  mutate(gender = 'Both sexes')

final_summary_data <- rbind(summary_data, both_sexes_data)
final_summary_data <- final_summary_data %>%
  arrange(gender, age_group) %>%
  rename(Sex = gender, Age.group = age_group)

combined_data <- left_join(grouped_data, final_summary_data, by = c("Sex", "Age.group"))
```

```{r}
library(broom)
perform_chi_square <- function(data) {
  contingency_table <- data %>%
    select(`Age.group`, `Yes, had long-term symptoms`, count) %>%
    mutate(No = (100 - `Yes, had long-term symptoms`) * count / 100,
           Yes = `Yes, had long-term symptoms` * count / 100) %>%
    select(-`Yes, had long-term symptoms`) %>%
    group_by(`Age.group`) 
  
  chi_square_result <- chisq.test(contingency_table[-1])
  
  return(chi_square_result)
}

results <- list()
sexes <- c("Males", "Females", "Both sexes")
for (sex in sexes) {
  filtered_data <- combined_data %>% filter(Sex == sex)
  results[[sex]] <- perform_chi_square(filtered_data)
}

test_results <- lapply(results, tidy) %>% bind_rows() %>% mutate(Sex = sexes)
test_results <- select(test_results, Sex, statistic, p.value)

print(test_results)
```

## Section 3: Prevalence Modeling

# Result

## Section 1: Mortality

## Section 2: Long-term Impact

## Section 3: Prevalence Modeling

```{r}
WMortality%>%mutate(Year=year(REF_DATE), Week=substr(REF_DATE,6,10))%>%mutate(Year=factor(Year))%>%filter(Age.at.time.of.death=="Age at time of death, all ages" & Sex=="Both sexes" & GEO=="Canada, place of occurrence")%>%
  plot_ly(x=~Week, y=~VALUE, color=~Year,type = "scatter", mode="lines")
```

# Discussion

## Section 1: Mortality

## Section 2: Long-term Impact

## Section 3: Prevalence Modeling

# Conclusion

# References
